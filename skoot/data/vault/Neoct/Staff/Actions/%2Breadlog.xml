<object clone="/usr/SkotOS/obj/meracha" owner="TextIF">
  <SkotOS:MerAcHa action_id="+readlog">
    <Core:PCProperties>
      <Core:Property property="merry:global:action">
         X[M] /* Scan a log generated by Lib:logs */

constant HELP = "+readlog\\n\\nRead a log generated by Lib:logs/lib:add.\\n\\nExample: +readlog me 'audit:lastemittedtoby'\\n+readlog 'Woe:name property'";

\$tgt = \$actor."readlog:tgt";

if( \$dob \&\& sizeof( \$dob ))\{
  \$tgt = NRefOb( \$dob[0] );
  \$setgt = TRUE;
\}

if( !\$evoke \&\& \$setgt )\{

    \$actor."readlog:tgt" = \$tgt;

    \$z = Get( \$tgt, "*" );
    \$x = map_indices( \$z );
    EmitTo( \$actor, "Audit entries in "+dump_value( \$tgt )+":" );
    for( \$i = 0; \$i \< sizeof( \$x ); \$i++ )
      if( strlen( \$x[\$i] ) \> 5 \&\& \$x[\$i][..5] == "audit:" ) EmitTo( \$actor, " - " + \$x[\$i] );
    return FALSE;

\} else if( !\$evoke )\{

  EmitTo( \$actor, HELP );
  return FALSE;

\}

\$property = \$evoke[1..strlen(\$evoke)-2];

if( !\$setgt )\{

  if( sscanf( \$property, "%s %s", \$woename, \$prop ) != 2 )\{
    \$display_audit = TRUE;
    \$full_prop = TRUE;
    \$woename = \$property;
  \}

  \$tgt = Obj( \$woename );

  if( !\$tgt )\{
    if( \$display_audit )\{
      \$property = \$woename;
      \$tgt = \$actor."readlog:tgt";
      \$display_audit = FALSE;
    \}
    if( !\$tgt )\{
      EmitTo( \$actor, "Can't find the object "+\$woename+".\\n\\n"+HELP );
      return FALSE;
    \}
  \}

  if( \$display_audit )\{

    \$z = Get( \$tgt, "*" );
    \$x = map_indices( \$z );
    EmitTo( \$actor, "Audit entries in "+dump_value( \$tgt )+":" );
    for( \$i = 0; \$i \< sizeof( \$x ); \$i++ )
      if( strlen( \$x[\$i] ) \> 5 \&\& \$x[\$i][..5] == "audit:" ) EmitTo( \$actor, " - " + \$x[\$i] );
    return FALSE;

  \}

  if( !\$full_prop ) \$propetry = \$prop;

\}

\$actor."readlog:tgt" = \$tgt;

\$property = strip( \$property );
\$value = Get( \$tgt, \$property );

if( !\$value )\{

  EmitTo( \$actor, "No entries found in "+\$property+"." );
  return FALSE;

\}

\$indices = map_indices( \$value );

if( \$adverb \&\& \$adverb == "completely" ) \$show = 0; else
  \$show = sizeof( \$indices ) \< 11?0:sizeof( \$indices )-5;

for( \$i = sizeof( \$indices )-1; \$i \>= \$show; \$i-- )\{
  EmitTo( \$actor, TAG( "["+\$indices[\$i]+"]", "imp" ));
  \$val = \$value[\$indices[\$i]];
  EmitTo( \$actor, Call( nil /* defunct */, "resolve" ));
  EmitTo( \$actor, "\\n" );
\}

if( \$show != 0 )\{

  EmitTo( \$actor, "(There are "+Str(sizeof(\$indices))+" entries. Use +readlog complete(ly) to see all.)" );

\} else \{

  EmitTo( \$actor, "(Done.)" );

\}
      </Core:Property>
      <Core:Property property="revisions">
         (\{ 1135372226, "-", "SYNC" \})
      </Core:Property>
    </Core:PCProperties>
  </SkotOS:MerAcHa>
</object>
